<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È£ØÂ∫óÂåÖË£πÁÆ°ÁêÜÁ≥ªÁµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .nav-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }
        
        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            min-width: 200px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        select.form-input {
            cursor: pointer;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-notified {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .qr-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .qr-code {
            margin: 20px 0;
        }
        
        .scanner-container {
            margin: 20px 0;
        }
        
        #scanner {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border: 2px solid #3498db;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .nav-tab {
                padding: 12px 15px;
                font-size: 12px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè® È£ØÂ∫óÂåÖË£πÁÆ°ÁêÜÁ≥ªÁµ±</h1>
            <p>Êô∫ËÉΩÂåñÂåÖË£πÂØÑÂ≠òËàáÁÆ°ÁêÜËß£Ê±∫ÊñπÊ°à</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard" onclick="showTab('dashboard')">üìä Á∏ΩË¶Ω</button>
            <button class="nav-tab" data-tab="add" onclick="showTab('add')">‚ûï Êñ∞Â¢û</button>
            <button class="nav-tab" data-tab="list" onclick="showTab('list')">üìã Ê∏ÖÂñÆ</button>
            <button class="nav-tab" data-tab="scan" onclick="showTab('scan')">üì± ÊéÉÁ¢º</button>
        </div>
        
        <!-- Á∏ΩË¶ΩÈ†ÅÈù¢ -->
        <div class="tab-content active" id="dashboard">
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Á∏ΩË®àÈ†ÖÁõÆ</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954);">
                    <div class="stat-number" id="pendingCount">0</div>
                    <div class="stat-label">ÂæÖËôïÁêÜ</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                    <div class="stat-number" id="todayCount">0</div>
                    <div class="stat-label">‰ªäÊó•Êñ∞Â¢û</div>
                </div>
            </div>
            
            <h3>üì¶ ÊúÄÊñ∞È†ÖÁõÆ</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>‰ª£Ëôü</th>
                            <th>È°ûÂûã</th>
                            <th>Êî∂‰ª∂‰∫∫</th>
                            <th>ÊàøËôü</th>
                            <th>ÁãÄÊÖã</th>
                            <th>ÊôÇÈñì</th>
                        </tr>
                    </thead>
                    <tbody id="recentItems">
                        <tr>
                            <td colspan="6" class="loading">ËºâÂÖ•‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Êñ∞Â¢ûÈ†ÅÈù¢ -->
        <div class="tab-content" id="add">
            <h3>‚ûï Êñ∞Â¢ûÈ†ÖÁõÆ</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">È°ûÂûã</label>
                    <select class="form-input" id="itemType" onchange="updateFormFields()">
                        <option value="Âø´ÈÅûÂåÖË£π">üì¶ Âø´ÈÅûÂåÖË£π</option>
                        <option value="ÂØÑÂ≠òËΩâ‰∫§">üìã ÂØÑÂ≠òËΩâ‰∫§</option>
                        <option value="‰ª£‰ªòÊ¨æÈ†Ö">üí∞ ‰ª£‰ªòÊ¨æÈ†Ö</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Êî∂‰ª∂‰∫∫ÂßìÂêç</label>
                    <input type="text" class="form-input" id="recipientName" placeholder="Ë´ãËº∏ÂÖ•Êî∂‰ª∂‰∫∫ÂßìÂêç">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÊàøËôü</label>
                    <input type="text" class="form-input" id="roomNumber" placeholder="Ë´ãËº∏ÂÖ•ÊàøËôü">
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="senderLabel">Âø´ÈÅûÂÖ¨Âè∏</label>
                    <input type="text" class="form-input" id="sender" placeholder="Ë´ãËº∏ÂÖ•Âø´ÈÅûÂÖ¨Âè∏">
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="descriptionLabel">ËøΩËπ§ËôüÁ¢º</label>
                    <input type="text" class="form-input" id="description" placeholder="Ë´ãËº∏ÂÖ•ËøΩËπ§ËôüÁ¢º">
                </div>
                
                <div class="form-group" id="amountGroup" style="display: none;">
                    <label class="form-label">ÈáëÈ°ç</label>
                    <input type="number" class="form-input" id="amount" placeholder="Ë´ãËº∏ÂÖ•ÈáëÈ°ç">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ËôïÁêÜÂì°Â∑•</label>
                    <input type="text" class="form-input" id="staff" placeholder="Ë´ãËº∏ÂÖ•ËôïÁêÜÂì°Â∑•ÂßìÂêç">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÂÇôË®ª</label>
                    <input type="text" class="form-input" id="remarks" placeholder="ÈÅ∏Â°´">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="addItem()">
                ‚ûï Êñ∞Â¢ûÈ†ÖÁõÆ
            </button>
            
            <div id="addResult"></div>
        </div>
        
        <!-- Ê∏ÖÂñÆÈ†ÅÈù¢ -->
        <div class="tab-content" id="list">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç ÊêúÂ∞ã‰ª£Ëôü„ÄÅÂßìÂêç„ÄÅÊàøËôü„ÄÅËøΩËπ§ËôüÁ¢º..." onkeyup="searchItems()">
                <select class="form-input" id="filterType" onchange="searchItems()" style="flex: none; width: 150px;">
                    <option value="">ÂÖ®ÈÉ®È°ûÂûã</option>
                    <option value="Âø´ÈÅûÂåÖË£π">Âø´ÈÅûÂåÖË£π</option>
                    <option value="ÂØÑÂ≠òËΩâ‰∫§">ÂØÑÂ≠òËΩâ‰∫§</option>
                    <option value="‰ª£‰ªòÊ¨æÈ†Ö">‰ª£‰ªòÊ¨æÈ†Ö</option>
                </select>
                <select class="form-input" id="filterStatus" onchange="searchItems()" style="flex: none; width: 120px;">
                    <option value="">ÂÖ®ÈÉ®ÁãÄÊÖã</option>
                    <option value="ÂæÖËôïÁêÜ">ÂæÖËôïÁêÜ</option>
                    <option value="Â∑≤ÈÄöÁü•">Â∑≤ÈÄöÁü•</option>
                    <option value="Â∑≤Âèñ‰ª∂">Â∑≤Âèñ‰ª∂</option>
                    <option value="Â∑≤ÂÆåÊàê">Â∑≤ÂÆåÊàê</option>
                </select>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>‰ª£Ëôü</th>
                            <th>È°ûÂûã</th>
                            <th>Êî∂‰ª∂‰∫∫</th>
                            <th>ÊàøËôü</th>
                            <th>ÂØÑ‰ª∂‰∫∫/ÂÖ¨Âè∏</th>
                            <th>ÊèèËø∞/ËøΩËπ§Ëôü</th>
                            <th>ÈáëÈ°ç</th>
                            <th>ÁãÄÊÖã</th>
                            <th>Âì°Â∑•</th>
                            <th>Âª∫Á´ãÊôÇÈñì</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="itemsList">
                        <tr>
                            <td colspan="11" class="loading">ËºâÂÖ•‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ÊéÉÁ¢ºÈ†ÅÈù¢ -->
        <div class="tab-content" id="scan">
            <h3>üì± ÊéÉÁ¢ºÊü•Ë©¢ËàáÊ†∏Èä∑</h3>
            
            <div class="scanner-container">
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="startScanner()">üì∑ ÈñãÂïüÁõ∏Ê©üÊéÉÊèè</button>
                    <button class="btn btn-warning" onclick="stopScanner()">‚èπÔ∏è ÂÅúÊ≠¢ÊéÉÊèè</button>
                </div>
                
                <div id="scanner" style="margin: 0 auto;"></div>
                
                <div style="margin-top: 20px;">
                    <input type="text" class="search-input" id="manualCode" placeholder="ÊàñÊâãÂãïËº∏ÂÖ•‰ª£Ëôü..." style="width: 100%;">
                    <button class="btn btn-success" onclick="searchByCode()" style="margin-top: 10px; width: 100%;">üîç Êü•Ë©¢</button>
                </div>
            </div>
            
            <div id="scanResult"></div>
        </div>
    </div>
    
    <!-- QRÁ¢ºÂΩàÁ™ó -->
    <div class="qr-modal" id="qrModal">
        <div class="qr-content">
            <h3>üì± Âèñ‰ª∂‰ª£Ëôü</h3>
            <div class="qr-code" id="qrCodeContainer"></div>
            <p><strong>‰ª£ËôüÔºö<span id="qrCodeText"></span></strong></p>
            <p>Ë´ãÂ∞áÊ≠§QRÁ¢ºÂàÜ‰∫´Áµ¶Êî∂‰ª∂‰∫∫</p>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="downloadQR()">üíæ ‰∏ãËºâQRÁ¢º</button>
                <button class="btn btn-danger" onclick="closeQR()">‚ùå ÈóúÈñâ</button>
            </div>
        </div>
    </div>

    <!-- QRÁ¢ºÁîüÊàêÂ∫´ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        const SHEET_ID = '10xS27HgTR6mOrIhroXHEj1CLSWDqClV47_iisw4v93E';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Â∑•‰ΩúË°®1`;
        // Google Form formResponse URL
        const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdmPGJy_Lc_rqUeWvVpbEVVNmttJkIUI-UEwW3qnJSppif8gA/formResponse';
        let allData = [];
        let isScanning = false;

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Á≥ªÁµ±ÂàùÂßãÂåñ‰∏≠...');
            
            // Á¢∫‰øùÊâÄÊúâÂáΩÊï∏ÈÉΩÂ∑≤ÂÆöÁæ©
            window.showTab = showTab;
            window.addItem = addItem;
            window.searchItems = searchItems;
            window.updateFormFields = updateFormFields;
            window.showQR = showQR;
            window.closeQR = closeQR;
            window.downloadQR = downloadQR;
            window.startScanner = startScanner;
            window.stopScanner = stopScanner;
            window.searchByCode = searchByCode;
            window.updateStatus = updateStatus;
            
            // ËºâÂÖ•Ë≥áÊñô
            loadData();
            setInterval(loadData, 30000); // ÊØè30ÁßíËá™ÂãïÈáçÊñ∞ËºâÂÖ•
            
            console.log('Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê');
        });

        // ËºâÂÖ•Ë≥áÊñô
        async function loadData() {
            try {
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                
                // ÁßªÈô§ Google ÂåÖË£ùÁöÑÂâçÂæåÁ∂¥
                const jsonText = text.substring(47, text.length - 2);
                const json = JSON.parse(jsonText);
                
                allData = [];
                if (json && json.table && json.table.rows) {
                    json.table.rows.forEach((row, index) => {
                        if (row.c && row.c[0] && row.c[0].v && index > 0) { // Ë∑≥ÈÅéÊ®ôÈ°åË°å
                            allData.push({
                                datetime: row.c[0] ? (row.c[0].v || '') : '',
                                type: row.c[1] ? (row.c[1].v || '') : '',
                                code: row.c[2] ? (row.c[2].v || '') : '',
                                recipient: row.c[3] ? (row.c[3].v || '') : '',
                                room: row.c[4] ? (row.c[4].v || '') : '',
                                sender: row.c[5] ? (row.c[5].v || '') : '',
                                description: row.c[6] ? (row.c[6].v || '') : '',
                                amount: row.c[7] ? (row.c[7].v || '') : '',
                                status: row.c[8] ? (row.c[8].v || '') : '',
                                staff: row.c[9] ? (row.c[9].v || '') : '',
                                remarks: row.c[10] ? (row.c[10].v || '') : '',
                                completedTime: row.c[11] ? (row.c[11].v || '') : ''
                            });
                        }
                    });
                }
                
                updateDashboard();
                displayItems(allData);
                
            } catch (error) {
                console.error('ËºâÂÖ•Ë≥áÊñôÂ§±Êïó:', error);
                showMessage('ËºâÂÖ•Ë≥áÊñôÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñÁ®çÂæåÂÜçË©¶', 'error');
                
                // È°ØÁ§∫Á§∫ÁØÑË≥áÊñô
                allData = [
                    {
                        datetime: '2024-12-19 10:30:00',
                        type: 'Âø´ÈÅûÂåÖË£π',
                        code: 'EX24121901',
                        recipient: 'ÂºµÂ∞èÊòé',
                        room: '301',
                        sender: 'È†ÜË±êÂø´ÈÅû',
                        description: 'SF1234567890',
                        amount: '',
                        status: 'ÂæÖËôïÁêÜ',
                        staff: 'Ê´ÉÂè∞‰∫∫Âì°',
                        remarks: '',
                        completedTime: ''
                    }
                ];
                updateDashboard();
                displayItems(allData);
            }
        }

        // Êõ¥Êñ∞Á∏ΩË¶ΩÁµ±Ë®à
        function updateDashboard() {
            const totalCount = allData.length;
            const pendingCount = allData.filter(item => item.status === 'ÂæÖËôïÁêÜ' || item.status === 'Â∑≤ÈÄöÁü•').length;
            const today = new Date().toISOString().split('T')[0];
            const todayCount = allData.filter(item => item.datetime && item.datetime.includes(today)).length;

            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('todayCount').textContent = todayCount;

            // Êõ¥Êñ∞ÊúÄÊñ∞È†ÖÁõÆ
            const recentItems = allData.slice(-10).reverse();
            const tbody = document.getElementById('recentItems');
            tbody.innerHTML = '';

            if (recentItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Êö´ÁÑ°Ë≥áÊñô</td></tr>';
                return;
            }

            recentItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.code}</strong></td>
                    <td>${getTypeIcon(item.type)} ${item.type}</td>
                    <td>${item.recipient}</td>
                    <td>${item.room}</td>
                    <td><span class="status status-${getStatusClass(item.status)}">${item.status}</span></td>
                    <td>${formatDateTime(item.datetime)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // È°ØÁ§∫È†ÖÁõÆÊ∏ÖÂñÆ
        function displayItems(items) {
            const tbody = document.getElementById('itemsList');
            tbody.innerHTML = '';

            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="loading">Êö´ÁÑ°Ë≥áÊñô</td></tr>';
                return;
            }

            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.code}</strong></td>
                    <td>${getTypeIcon(item.type)} ${item.type}</td>
                    <td>${item.recipient}</td>
                    <td>${item.room}</td>
                    <td>${item.sender}</td>
                    <td>${item.description}</td>
                    <td>${item.amount ? '$' + item.amount : '-'}</td>
                    <td><span class="status status-${getStatusClass(item.status)}">${item.status}</span></td>
                    <td>${item.staff}</td>
                    <td>${formatDateTime(item.datetime)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="window.showQR('${item.code}')">QRÁ¢º</button>
                        <select onchange="window.updateStatus('${item.code}', this.value)" class="btn btn-sm">
                            <option value="">Êõ¥Êñ∞ÁãÄÊÖã</option>
                            <option value="ÂæÖËôïÁêÜ">ÂæÖËôïÁêÜ</option>
                            <option value="Â∑≤ÈÄöÁü•">Â∑≤ÈÄöÁü•</option>
                            <option value="Â∑≤Âèñ‰ª∂">Â∑≤Âèñ‰ª∂</option>
                            <option value="Â∑≤ÂÆåÊàê">Â∑≤ÂÆåÊàê</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Êñ∞Â¢ûÈ†ÖÁõÆ
        async function addItem() {
            const type = document.getElementById('itemType').value;
            const recipient = document.getElementById('recipientName').value.trim();
            const room = document.getElementById('roomNumber').value.trim();
            const sender = document.getElementById('sender').value.trim();
            const description = document.getElementById('description').value.trim();
            const amount = document.getElementById('amount').value;
            const staff = document.getElementById('staff').value.trim();
            const remarks = document.getElementById('remarks').value.trim();

            if (!recipient || !room || !sender || !description || !staff) {
                showMessage('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç', 'error');
                return;
            }

            // ÁîüÊàê‰ª£Ëôü
            const code = generateCode(type);
            const datetime = new Date().toISOString().replace('T', ' ').substr(0, 19);

            try {
                // Êèê‰∫§Âà∞ Google Form
                const formData = new FormData();
                
                // Google Form Ê¨Ñ‰ΩçÂ∞çÊáâ
                formData.append('entry.2007535861', datetime);        // Âª∫Á´ãÊôÇÈñì
                formData.append('entry.162414205', type);             // È°ûÂûã
                formData.append('entry.1136710868', code);             // ‰ª£Ëôü
                formData.append('entry.430243658', recipient);        // Êî∂‰ª∂‰∫∫ÂßìÂêç
                formData.append('entry.1230181809', room);             // ÊàøËôü
                formData.append('entry.855684639', sender);           // ÂØÑ‰ª∂‰∫∫/Âø´ÈÅûÂÖ¨Âè∏
                formData.append('entry.1253692676', description);      // ËøΩËπ§ËôüÁ¢º/Áâ©ÂìÅÊèèËø∞/‰ª£‰ªòÈ†ÖÁõÆ
                formData.append('entry.1634432783', amount || '');     // ÈáëÈ°ç
                formData.append('entry.1157995135', 'ÂæÖËôïÁêÜ');         // ÁãÄÊÖã
                formData.append('entry.1511756192', staff);            // ËôïÁêÜÂì°Â∑•
                formData.append('entry.1580604911', remarks);          // ÂÇôË®ª
                formData.append('entry.1973163786', '');               // ÂÆåÊàêÊôÇÈñì

                // ‰ΩøÁî® fetch Êèê‰∫§Ë≥áÊñôÔºàno-cors Ê®°ÂºèÈÅøÂÖç CORS ÂïèÈ°åÔºâ
                await fetch(FORM_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });

                showMessage(`È†ÖÁõÆÂ∑≤Êñ∞Â¢ûÔºÅ‰ª£ËôüÔºö${code}`, 'success');
                
                // Ê∏ÖÁ©∫Ë°®ÂñÆ
                document.getElementById('recipientName').value = '';
                document.getElementById('roomNumber').value = '';
                document.getElementById('sender').value = '';
                document.getElementById('description').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('staff').value = '';
                document.getElementById('remarks').value = '';

                // È°ØÁ§∫QRÁ¢º
                setTimeout(() => {
                    showQR(code);
                }, 1000);

                // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
                setTimeout(loadData, 3000);

            } catch (error) {
                console.error('Êñ∞Â¢ûÂ§±Êïó:', error);
                showMessage('Êñ∞Â¢ûÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        // ÁîüÊàê‰ª£Ëôü
        function generateCode(type) {
            const date = new Date();
            const dateStr = date.getFullYear().toString().substr(-2) + 
                          String(date.getMonth() + 1).padStart(2, '0') + 
                          String(date.getDate()).padStart(2, '0');
            
            let prefix = '';
            switch(type) {
                case 'Âø´ÈÅûÂåÖË£π': prefix = 'EX'; break;
                case 'ÂØÑÂ≠òËΩâ‰∫§': prefix = 'ST'; break;
                case '‰ª£‰ªòÊ¨æÈ†Ö': prefix = 'PY'; break;
            }
            
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${dateStr}${random}`;
        }

        // ÊêúÂ∞ãÈ†ÖÁõÆ
        function searchItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;

            let filteredData = allData.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.code.toLowerCase().includes(searchTerm) ||
                    item.recipient.toLowerCase().includes(searchTerm) ||
                    item.room.toLowerCase().includes(searchTerm) ||
                    item.description.toLowerCase().includes(searchTerm);
                
                const matchesType = !typeFilter || item.type === typeFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;

                return matchesSearch && matchesType && matchesStatus;
            });

            displayItems(filteredData);
        }

        // È°ØÁ§∫QRÁ¢º
        function showQR(code) {
            document.getElementById('qrCodeText').textContent = code;
            
            // Ê∏ÖÁ©∫ËàäÁöÑQRÁ¢º
            const container = document.getElementById('qrCodeContainer');
            container.innerHTML = '';
            
            // ‰ΩøÁî®qrcode-generatorÁîüÊàêQRÁ¢º
            try {
                const qr = qrcode(0, 'M');
                qr.addData(code);
                qr.make();
                
                // ÂâµÂª∫QRÁ¢ºÂúñÁâá
                const qrDiv = document.createElement('div');
                qrDiv.innerHTML = qr.createImgTag(4, 8);
                qrDiv.style.textAlign = 'center';
                container.appendChild(qrDiv);
                
            } catch (error) {
                // Â¶ÇÊûúQRÁ¢ºÂ∫´Â§±ÊïóÔºåÈ°ØÁ§∫ÊñáÂ≠óÁâàÊú¨
                container.innerHTML = `
                    <div style="border: 2px solid #333; padding: 20px; font-family: monospace; font-size: 18px; text-align: center;">
                        ${code}
                    </div>
                `;
            }
            
            document.getElementById('qrModal').style.display = 'flex';
        }

        // ÈóúÈñâQRÁ¢ºÂΩàÁ™ó
        function closeQR() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // ‰∏ãËºâQRÁ¢º
        function downloadQR() {
            const code = document.getElementById('qrCodeText').textContent;
            const img = document.querySelector('#qrCodeContainer img');
            
            if (img) {
                // Â¶ÇÊûúÊúâQRÁ¢ºÂúñÁâáÔºåÂâµÂª∫‰∏ãËºâÈÄ£Áµê
                const link = document.createElement('a');
                link.download = `QR_${code}.png`;
                link.href = img.src;
                link.click();
            } else {
                // Â¶ÇÊûúÊ≤íÊúâÂúñÁâáÔºåÊèêÁ§∫Áî®Êà∂Êà™Âúñ
                alert(`Ë´ãÊà™Âúñ‰øùÂ≠òQRÁ¢º\n‰ª£ËôüÔºö${code}`);
            }
        }

        // ÈñãÂßãÊéÉÊèèÔºàÁ∞°ÂåñÁâàÊú¨Ôºâ
        function startScanner() {
            if (isScanning) return;
            
            const scanner = document.getElementById('scanner');
            scanner.innerHTML = '<div style="padding: 20px; text-align: center;">Ê≠£Âú®ÂïüÂãïÁõ∏Ê©ü...</div>';
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 300 },
                        height: { ideal: 200 }
                    } 
                })
                .then(function(stream) {
                    isScanning = true;
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'cover';
                    
                    scanner.innerHTML = '';
                    scanner.appendChild(video);
                    
                    // È°ØÁ§∫‰ΩøÁî®ÊèêÁ§∫
                    const tip = document.createElement('div');
                    tip.innerHTML = '<p style="margin-top: 10px; font-size: 12px; color: #666;">üì± Ë´ãÂ∞áQRÁ¢ºÂ∞çÊ∫ñÁõ∏Ê©üÔºåÁÑ∂ÂæåÂú®‰∏ãÊñπÊâãÂãïËº∏ÂÖ•‰ª£Ëôü</p>';
                    scanner.appendChild(tip);
                    
                })
                .catch(function(error) {
                    console.error('ÁÑ°Ê≥ïÂïüÂãïÁõ∏Ê©ü:', error);
                    scanner.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">ÁÑ°Ê≥ïÂïüÂãïÁõ∏Ê©üÔºåË´ã‰ΩøÁî®ÊâãÂãïËº∏ÂÖ•</div>';
                });
            } else {
                scanner.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Áõ∏Ê©üÂäüËÉΩÔºåË´ã‰ΩøÁî®ÊâãÂãïËº∏ÂÖ•</div>';
            }
        }

        // ÂÅúÊ≠¢ÊéÉÊèè
        function stopScanner() {
            isScanning = false;
            const scanner = document.getElementById('scanner');
            const video = scanner.querySelector('video');
            
            if (video && video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
            }
            
            scanner.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Áõ∏Ê©üÂ∑≤ÂÅúÊ≠¢</div>';
        }

        // Ê†πÊìö‰ª£ËôüÊêúÂ∞ã
        function searchByCode() {
            const code = document.getElementById('manualCode').value.trim();
            if (!code) {
                showMessage('Ë´ãËº∏ÂÖ•‰ª£Ëôü', 'error');
                return;
            }
            
            const item = allData.find(item => item.code === code);
            const resultDiv = document.getElementById('scanResult');
            
            if (item) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ ÊâæÂà∞È†ÖÁõÆ</h4>
                        <div style="margin: 15px 0;">
                            <p><strong>‰ª£ËôüÔºö</strong>${item.code}</p>
                            <p><strong>È°ûÂûãÔºö</strong>${getTypeIcon(item.type)} ${item.type}</p>
                            <p><strong>Êî∂‰ª∂‰∫∫Ôºö</strong>${item.recipient}</p>
                            <p><strong>ÊàøËôüÔºö</strong>${item.room}</p>
                            <p><strong>ÂØÑ‰ª∂‰∫∫Ôºö</strong>${item.sender}</p>
                            <p><strong>ÊèèËø∞Ôºö</strong>${item.description}</p>
                            ${item.amount ? `<p><strong>ÈáëÈ°çÔºö</strong>$${item.amount}</p>` : ''}
                            <p><strong>ÁãÄÊÖãÔºö</strong><span class="status status-${getStatusClass(item.status)}">${item.status}</span></p>
                            <p><strong>ËôïÁêÜÂì°Â∑•Ôºö</strong>${item.staff}</p>
                            <p><strong>Âª∫Á´ãÊôÇÈñìÔºö</strong>${formatDateTime(item.datetime)}</p>
                            ${item.remarks ? `<p><strong>ÂÇôË®ªÔºö</strong>${item.remarks}</p>` : ''}
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="window.updateStatus('${item.code}', 'Â∑≤Âèñ‰ª∂')">‚úÖ Ê®ôË®òÂ∑≤Âèñ‰ª∂</button>
                            <button class="btn btn-warning" onclick="window.updateStatus('${item.code}', 'Â∑≤ÈÄöÁü•')">üìû Ê®ôË®òÂ∑≤ÈÄöÁü•</button>
                            <button class="btn btn-primary" onclick="window.showQR('${item.code}')">üì± È°ØÁ§∫QRÁ¢º</button>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Êú™ÊâæÂà∞È†ÖÁõÆ</h4>
                        <p>‰ª£Ëôü "${code}" ‰∏çÂ≠òÂú®ÔºåË´ãÊ™¢Êü•Ëº∏ÂÖ•ÊòØÂê¶Ê≠£Á¢∫</p>
                    </div>
                `;
            }
            
            document.getElementById('manualCode').value = '';
        }

        // Êõ¥Êñ∞ÁãÄÊÖã
        async function updateStatus(code, newStatus) {
            if (!newStatus) return;
            
            try {
                // ÈÄôË£°ÈúÄË¶ÅÂëºÂè´ Google Sheets API ‰æÜÊõ¥Êñ∞Ë≥áÊñô
                // Áî±ÊñºÊòØÁ§∫ÁØÑÁâàÊú¨ÔºåÊàëÂÄëÂÖàÂú®ÂâçÁ´ØÊ®°Êì¨Êõ¥Êñ∞
                const item = allData.find(item => item.code === code);
                if (item) {
                    item.status = newStatus;
                    if (newStatus === 'Â∑≤ÂÆåÊàê' || newStatus === 'Â∑≤Âèñ‰ª∂') {
                        item.completedTime = new Date().toISOString().replace('T', ' ').substr(0, 19);
                    }
                }
                
                showMessage(`ÁãÄÊÖãÂ∑≤Êõ¥Êñ∞Ôºö${code} ‚Üí ${newStatus}`, 'success');
                
                // ÈáçÊñ∞Êï¥ÁêÜÈ°ØÁ§∫
                searchItems();
                updateDashboard();
                
                // Ê∏ÖÁ©∫ÊéÉÊèèÁµêÊûú‰∏≠ÁöÑÁãÄÊÖãÊõ¥Êñ∞
                const scanResult = document.getElementById('scanResult');
                if (scanResult.innerHTML.includes(code)) {
                    searchByCode();
                }
                
            } catch (error) {
                console.error('Êõ¥Êñ∞ÁãÄÊÖãÂ§±Êïó:', error);
                showMessage('Êõ¥Êñ∞ÁãÄÊÖãÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        // ÂàáÊèõÊ®ôÁ±§È†Å
        function showTab(tabName) {
            // Èö±ËóèÊâÄÊúâÊ®ôÁ±§ÂÖßÂÆπ
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // ÁßªÈô§ÊâÄÊúâÊ®ôÁ±§ÊåâÈàïÁöÑ active ÁãÄÊÖã
            const buttons = document.querySelectorAll('.nav-tab');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÂÖßÂÆπ
            document.getElementById(tabName).classList.add('active');
            
            // ÊâæÂà∞Â∞çÊáâÁöÑÊåâÈàï‰∏¶Ë®≠ÁÇ∫ active
            const activeButton = Array.from(buttons).find(btn => btn.onclick.toString().includes(tabName));
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // ÂÅúÊ≠¢ÊéÉÊèèÂ¶ÇÊûúÈõ¢ÈñãÊéÉÊèèÈ†ÅÈù¢
            if (tabName !== 'scan') {
                stopScanner();
            }
        }

        // Êõ¥Êñ∞Ë°®ÂñÆÊ¨Ñ‰Ωç
        function updateFormFields() {
            const type = document.getElementById('itemType').value;
            const senderLabel = document.getElementById('senderLabel');
            const descriptionLabel = document.getElementById('descriptionLabel');
            const amountGroup = document.getElementById('amountGroup');
            
            switch(type) {
                case 'Âø´ÈÅûÂåÖË£π':
                    senderLabel.textContent = 'Âø´ÈÅûÂÖ¨Âè∏';
                    descriptionLabel.textContent = 'ËøΩËπ§ËôüÁ¢º';
                    amountGroup.style.display = 'none';
                    document.getElementById('sender').placeholder = 'Ë´ãËº∏ÂÖ•Âø´ÈÅûÂÖ¨Âè∏';
                    document.getElementById('description').placeholder = 'Ë´ãËº∏ÂÖ•ËøΩËπ§ËôüÁ¢º';
                    break;
                case 'ÂØÑÂ≠òËΩâ‰∫§':
                    senderLabel.textContent = 'ÂØÑ‰ª∂‰∫∫';
                    descriptionLabel.textContent = 'Áâ©ÂìÅÊèèËø∞';
                    amountGroup.style.display = 'none';
                    document.getElementById('sender').placeholder = 'Ë´ãËº∏ÂÖ•ÂØÑ‰ª∂‰∫∫';
                    document.getElementById('description').placeholder = 'Ë´ãËº∏ÂÖ•Áâ©ÂìÅÊèèËø∞';
                    break;
                case '‰ª£‰ªòÊ¨æÈ†Ö':
                    senderLabel.textContent = '‰ªòÊ¨æÂ∞çË±°';
                    descriptionLabel.textContent = '‰ªòÊ¨æÈ†ÖÁõÆ';
                    amountGroup.style.display = 'block';
                    document.getElementById('sender').placeholder = 'Ë´ãËº∏ÂÖ•‰ªòÊ¨æÂ∞çË±°';
                    document.getElementById('description').placeholder = 'Ë´ãËº∏ÂÖ•‰ªòÊ¨æÈ†ÖÁõÆ';
                    break;
            }
        }

        // Â∑•ÂÖ∑ÂáΩÊï∏
        function getTypeIcon(type) {
            switch(type) {
                case 'Âø´ÈÅûÂåÖË£π': return 'üì¶';
                case 'ÂØÑÂ≠òËΩâ‰∫§': return 'üìã';
                case '‰ª£‰ªòÊ¨æÈ†Ö': return 'üí∞';
                default: return 'üìÑ';
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'ÂæÖËôïÁêÜ': return 'pending';
                case 'Â∑≤ÈÄöÁü•': return 'notified';
                case 'Â∑≤Âèñ‰ª∂':
                case 'Â∑≤ÂÆåÊàê': return 'completed';
                default: return 'pending';
            }
        }

        function formatDateTime(datetime) {
            if (!datetime) return '-';
            const date = new Date(datetime);
            return date.toLocaleString('zh-TW', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showMessage(message, type) {
            const resultDivs = ['addResult', 'scanResult'];
            resultDivs.forEach(divId => {
                const div = document.getElementById(divId);
                if (div) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = type;
                    messageDiv.textContent = message;
                    div.innerHTML = '';
                    div.appendChild(messageDiv);
                    
                    // 3ÁßíÂæåËá™ÂãïÊ∏ÖÈô§Ë®äÊÅØ
                    setTimeout(() => {
                        if (div.contains(messageDiv)) {
                            div.removeChild(messageDiv);
                        }
                    }, 3000);
                }
            });
        }

        // ÈªûÊìäÂΩàÁ™óÂ§ñÈÉ®ÈóúÈñâ
        document.getElementById('qrModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeQR();
            }
        });

        // ÂàùÂßãÂåñË°®ÂñÆÊ¨Ñ‰Ωç
        updateFormFields();
