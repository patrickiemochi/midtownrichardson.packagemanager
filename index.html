<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£¯åº—åŒ…è£¹ç®¡ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .nav-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }
        
        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            min-width: 200px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        select.form-input {
            cursor: pointer;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-notified {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .qr-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .qr-code {
            margin: 20px 0;
        }
        
        .scanner-container {
            margin: 20px 0;
        }
        
        #scanner {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border: 2px solid #3498db;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .nav-tab {
                padding: 12px 15px;
                font-size: 12px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ é£¯åº—åŒ…è£¹ç®¡ç†ç³»çµ±</h1>
            <p>æ™ºèƒ½åŒ–åŒ…è£¹å¯„å­˜èˆ‡ç®¡ç†è§£æ±ºæ–¹æ¡ˆ</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard" onclick="showTab('dashboard')">ğŸ“Š ç¸½è¦½</button>
            <button class="nav-tab" data-tab="add" onclick="showTab('add')">â• æ–°å¢</button>
            <button class="nav-tab" data-tab="list" onclick="showTab('list')">ğŸ“‹ æ¸…å–®</button>
            <button class="nav-tab" data-tab="scan" onclick="showTab('scan')">ğŸ“± æƒç¢¼</button>
        </div>
        
        <!-- ç¸½è¦½é é¢ -->
        <div class="tab-content active" id="dashboard">
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">ç¸½è¨ˆé …ç›®</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954);">
                    <div class="stat-number" id="pendingCount">0</div>
                    <div class="stat-label">å¾…è™•ç†</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                    <div class="stat-number" id="todayCount">0</div>
                    <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
                </div>
            </div>
            
            <h3>ğŸ“¦ æœ€æ–°é …ç›®</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ä»£è™Ÿ</th>
                            <th>é¡å‹</th>
                            <th>æ”¶ä»¶äºº</th>
                            <th>æˆ¿è™Ÿ</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="recentItems">
                        <tr>
                            <td colspan="6" class="loading">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æ–°å¢é é¢ -->
        <div class="tab-content" id="add">
            <h3>â• æ–°å¢é …ç›®</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">é¡å‹</label>
                    <select class="form-input" id="itemType" onchange="updateFormFields()">
                        <option value="å¿«éåŒ…è£¹">ğŸ“¦ å¿«éåŒ…è£¹</option>
                        <option value="å¯„å­˜è½‰äº¤">ğŸ“‹ å¯„å­˜è½‰äº¤</option>
                        <option value="ä»£ä»˜æ¬¾é …">ğŸ’° ä»£ä»˜æ¬¾é …</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ”¶ä»¶äººå§“å</label>
                    <input type="text" class="form-input" id="recipientName" placeholder="è«‹è¼¸å…¥æ”¶ä»¶äººå§“å">
                </div>
                
                <div class="form-group">
                    <label class="form-label">æˆ¿è™Ÿ</label>
                    <input type="text" class="form-input" id="roomNumber" placeholder="è«‹è¼¸å…¥æˆ¿è™Ÿ">
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="senderLabel">å¿«éå…¬å¸</label>
                    <input type="text" class="form-input" id="sender" placeholder="è«‹è¼¸å…¥å¿«éå…¬å¸">
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="descriptionLabel">è¿½è¹¤è™Ÿç¢¼</label>
                    <input type="text" class="form-input" id="description" placeholder="è«‹è¼¸å…¥è¿½è¹¤è™Ÿç¢¼">
                </div>
                
                <div class="form-group" id="amountGroup" style="display: none;">
                    <label class="form-label">é‡‘é¡</label>
                    <input type="number" class="form-input" id="amount" placeholder="è«‹è¼¸å…¥é‡‘é¡">
                </div>
                
                <div class="form-group">
                    <label class="form-label">è™•ç†å“¡å·¥</label>
                    <input type="text" class="form-input" id="staff" placeholder="è«‹è¼¸å…¥è™•ç†å“¡å·¥å§“å">
                </div>
                
                <div class="form-group">
                    <label class="form-label">å‚™è¨»</label>
                    <input type="text" class="form-input" id="remarks" placeholder="é¸å¡«">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="addItem()">
                â• æ–°å¢é …ç›®
            </button>
            
            <div id="addResult"></div>
        </div>
        
        <!-- æ¸…å–®é é¢ -->
        <div class="tab-content" id="list">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœå°‹ä»£è™Ÿã€å§“åã€æˆ¿è™Ÿã€è¿½è¹¤è™Ÿç¢¼..." onkeyup="searchItems()">
                <select class="form-input" id="filterType" onchange="searchItems()" style="flex: none; width: 150px;">
                    <option value="">å…¨éƒ¨é¡å‹</option>
                    <option value="å¿«éåŒ…è£¹">å¿«éåŒ…è£¹</option>
                    <option value="å¯„å­˜è½‰äº¤">å¯„å­˜è½‰äº¤</option>
                    <option value="ä»£ä»˜æ¬¾é …">ä»£ä»˜æ¬¾é …</option>
                </select>
                <select class="form-input" id="filterStatus" onchange="searchItems()" style="flex: none; width: 120px;">
                    <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                    <option value="å¾…è™•ç†">å¾…è™•ç†</option>
                    <option value="å·²é€šçŸ¥">å·²é€šçŸ¥</option>
                    <option value="å·²å–ä»¶">å·²å–ä»¶</option>
                    <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                </select>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ä»£è™Ÿ</th>
                            <th>é¡å‹</th>
                            <th>æ”¶ä»¶äºº</th>
                            <th>æˆ¿è™Ÿ</th>
                            <th>å¯„ä»¶äºº/å…¬å¸</th>
                            <th>æè¿°/è¿½è¹¤è™Ÿ</th>
                            <th>é‡‘é¡</th>
                            <th>ç‹€æ…‹</th>
                            <th>å“¡å·¥</th>
                            <th>å»ºç«‹æ™‚é–“</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="itemsList">
                        <tr>
                            <td colspan="11" class="loading">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æƒç¢¼é é¢ -->
        <div class="tab-content" id="scan">
            <h3>ğŸ“± æƒç¢¼æŸ¥è©¢èˆ‡æ ¸éŠ·</h3>
            
            <div class="scanner-container">
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="startScanner()">ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ</button>
                    <button class="btn btn-warning" onclick="stopScanner()">â¹ï¸ åœæ­¢æƒæ</button>
                </div>
                
                <div id="scanner" style="margin: 0 auto;"></div>
                
                <div style="margin-top: 20px;">
                    <input type="text" class="search-input" id="manualCode" placeholder="æˆ–æ‰‹å‹•è¼¸å…¥ä»£è™Ÿ..." style="width: 100%;">
                    <button class="btn btn-success" onclick="searchByCode()" style="margin-top: 10px; width: 100%;">ğŸ” æŸ¥è©¢</button>
                </div>
            </div>
            
            <div id="scanResult"></div>
        </div>
    </div>
    
    <!-- QRç¢¼å½ˆçª— -->
    <div class="qr-modal" id="qrModal">
        <div class="qr-content">
            <h3>ğŸ“± å–ä»¶ä»£è™Ÿ</h3>
            <div class="qr-code" id="qrCodeContainer"></div>
            <p><strong>ä»£è™Ÿï¼š<span id="qrCodeText"></span></strong></p>
            <p>è«‹å°‡æ­¤QRç¢¼åˆ†äº«çµ¦æ”¶ä»¶äºº</p>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="downloadQR()">ğŸ’¾ ä¸‹è¼‰QRç¢¼</button>
                <button class="btn btn-danger" onclick="closeQR()">âŒ é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- QRç¢¼ç”Ÿæˆåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <script>
        // å…¨åŸŸè®Šæ•¸
        const SHEET_ID = '10xS27HgTR6mOrIhroXHEj1CLSWDqClV47_iisw4v93E';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=å·¥ä½œè¡¨1`;
        // Google Form formResponse URL
        const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdmPGJy_Lc_rqUeWvVpbEVVNmttJkIUI-UEwW3qnJSppif8gA/formResponse';
        let allData = [];
        let isScanning = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç³»çµ±åˆå§‹åŒ–ä¸­...');
            
            // ç¢ºä¿æ‰€æœ‰å‡½æ•¸éƒ½å·²å®šç¾©
            window.showTab = showTab;
            window.addItem = addItem;
            window.searchItems = searchItems;
            window.updateFormFields = updateFormFields;
            window.showQR = showQR;
            window.closeQR = closeQR;
            window.downloadQR = downloadQR;
            window.startScanner = startScanner;
            window.stopScanner = stopScanner;
            window.searchByCode = searchByCode;
            window.updateStatus = updateStatus;
            
            // è¼‰å…¥è³‡æ–™
            loadData();
            setInterval(loadData, 30000); // æ¯30ç§’è‡ªå‹•é‡æ–°è¼‰å…¥
            
            console.log('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        });

        // è¼‰å…¥è³‡æ–™
        async function loadData() {
            try {
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                
                // ç§»é™¤ Google åŒ…è£çš„å‰å¾Œç¶´
                const jsonText = text.substring(47, text.length - 2);
                const json = JSON.parse(jsonText);
                
                allData = [];
                if (json && json.table && json.table.rows) {
                    json.table.rows.forEach((row, index) => {
                        if (row.c && row.c[0] && row.c[0].v && index > 0) { // è·³éæ¨™é¡Œè¡Œ
                            allData.push({
                                datetime: row.c[0] ? (row.c[0].v || '') : '',
                                type: row.c[1] ? (row.c[1].v || '') : '',
                                code: row.c[2] ? (row.c[2].v || '') : '',
                                recipient: row.c[3] ? (row.c[3].v || '') : '',
                                room: row.c[4] ? (row.c[4].v || '') : '',
                                sender: row.c[5] ? (row.c[5].v || '') : '',
                                description: row.c[6] ? (row.c[6].v || '') : '',
                                amount: row.c[7] ? (row.c[7].v || '') : '',
                                status: row.c[8] ? (row.c[8].v || '') : '',
                                staff: row.c[9] ? (row.c[9].v || '') : '',
                                remarks: row.c[10] ? (row.c[10].v || '') : '',
                                completedTime: row.c[11] ? (row.c[11].v || '') : ''
                            });
                        }
                    });
                }
                
                updateDashboard();
                displayItems(allData);
                
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                showMessage('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦', 'error');
                
                // é¡¯ç¤ºç¤ºç¯„è³‡æ–™
                allData = [
                    {
                        datetime: '2024-12-19 10:30:00',
                        type: 'å¿«éåŒ…è£¹',
                        code: 'EX24121901',
                        recipient: 'å¼µå°æ˜',
                        room: '301',
                        sender: 'é †è±å¿«é',
                        description: 'SF1234567890',
                        amount: '',
                        status: 'å¾…è™•ç†',
                        staff: 'æ«ƒå°äººå“¡',
                        remarks: '',
                        completedTime: ''
                    }
                ];
                updateDashboard();
                displayItems(allData);
            }
        }

        // æ›´æ–°ç¸½è¦½çµ±è¨ˆ
        function updateDashboard() {
            const totalCount = allData.length;
            const pendingCount = allData.filter(item => item.status === 'å¾…è™•ç†' || item.status === 'å·²é€šçŸ¥').length;
            const today = new Date().toISOString().split('T')[0];
            const todayCount = allData.filter(item => item.datetime && item.datetime.includes(today)).length;

            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('todayCount').textContent = todayCount;

            // æ›´æ–°æœ€æ–°é …ç›®
            const recentItems = allData.slice(-10).reverse();
            const tbody = document.getElementById('recentItems');
            tbody.innerHTML = '';

            if (recentItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                return;
            }

            recentItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.code}</strong></td>
                    <td>${getTypeIcon(item.type)} ${item.type}</td>
                    <td>${item.recipient}</td>
                    <td>${item.room}</td>
                    <td><span class="status status-${getStatusClass(item.status)}">${item.status}</span></td>
                    <td>${formatDateTime(item.datetime)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // é¡¯ç¤ºé …ç›®æ¸…å–®
        function displayItems(items) {
            const tbody = document.getElementById('itemsList');
            tbody.innerHTML = '';

            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                return;
            }

            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.code}</strong></td>
                    <td>${getTypeIcon(item.type)} ${item.type}</td>
                    <td>${item.recipient}</td>
                    <td>${item.room}</td>
                    <td>${item.sender}</td>
                    <td>${item.description}</td>
                    <td>${item.amount ? '$' + item.amount : '-'}</td>
                    <td><span class="status status-${getStatusClass(item.status)}">${item.status}</span></td>
                    <td>${item.staff}</td>
                    <td>${formatDateTime(item.datetime)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="window.showQR('${item.code}')">QRç¢¼</button>
                        <select onchange="window.updateStatus('${item.code}', this.value)" class="btn btn-sm">
                            <option value="">æ›´æ–°ç‹€æ…‹</option>
                            <option value="å¾…è™•ç†">å¾…è™•ç†</option>
                            <option value="å·²é€šçŸ¥">å·²é€šçŸ¥</option>
                            <option value="å·²å–ä»¶">å·²å–ä»¶</option>
                            <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ–°å¢é …ç›®
        async function addItem() {
            const type = document.getElementById('itemType').value;
            const recipient = document.getElementById('recipientName').value.trim();
            const room = document.getElementById('roomNumber').value.trim();
            const sender = document.getElementById('sender').value.trim();
            const description = document.getElementById('description').value.trim();
            const amount = document.getElementById('amount').value;
            const staff = document.getElementById('staff').value.trim();
            const remarks = document.getElementById('remarks').value.trim();

            if (!recipient || !room || !sender || !description || !staff) {
                showMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }

            // ç”Ÿæˆä»£è™Ÿ
            const code = generateCode(type);
            const datetime = new Date().toISOString().replace('T', ' ').substr(0, 19);

            try {
                // æäº¤åˆ° Google Form
                const formData = new FormData();
                
                // Google Form æ¬„ä½å°æ‡‰
                formData.append('entry.2007535861', datetime);        // å»ºç«‹æ™‚é–“
                formData.append('entry.162414205', type);             // é¡å‹
                formData.append('entry.1136710868', code);             // ä»£è™Ÿ
                formData.append('entry.430243658', recipient);        // æ”¶ä»¶äººå§“å
                formData.append('entry.1230181809', room);             // æˆ¿è™Ÿ
                formData.append('entry.855684639', sender);           // å¯„ä»¶äºº/å¿«éå…¬å¸
                formData.append('entry.1253692676', description);      // è¿½è¹¤è™Ÿç¢¼/ç‰©å“æè¿°/ä»£ä»˜é …ç›®
                formData.append('entry.1634432783', amount || '');     // é‡‘é¡
                formData.append('entry.1157995135', 'å¾…è™•ç†');         // ç‹€æ…‹
                formData.append('entry.1511756192', staff);            // è™•ç†å“¡å·¥
                formData.append('entry.1580604911', remarks);          // å‚™è¨»
                formData.append('entry.1973163786', '');               // å®Œæˆæ™‚é–“

                // ä½¿ç”¨ fetch æäº¤è³‡æ–™ï¼ˆno-cors æ¨¡å¼é¿å… CORS å•é¡Œï¼‰
                await fetch(FORM_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });

                showMessage(`é …ç›®å·²æ–°å¢ï¼ä»£è™Ÿï¼š${code}`, 'success');
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('recipientName').value = '';
                document.getElementById('roomNumber').value = '';
                document.getElementById('sender').value = '';
                document.getElementById('description').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('staff').value = '';
                document.getElementById('remarks').value = '';

                // é¡¯ç¤ºQRç¢¼
                setTimeout(() => {
                    showQR(code);
                }, 1000);

                // é‡æ–°è¼‰å…¥è³‡æ–™
                setTimeout(loadData, 3000);

            } catch (error) {
                console.error('æ–°å¢å¤±æ•—:', error);
                showMessage('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // ç”Ÿæˆä»£è™Ÿ
        function generateCode(type) {
            const date = new Date();
            const dateStr = date.getFullYear().toString().substr(-2) + 
                          String(date.getMonth() + 1).padStart(2, '0') + 
                          String(date.getDate()).padStart(2, '0');
            
            let prefix = '';
            switch(type) {
                case 'å¿«éåŒ…è£¹': prefix = 'EX'; break;
                case 'å¯„å­˜è½‰äº¤': prefix = 'ST'; break;
                case 'ä»£ä»˜æ¬¾é …': prefix = 'PY'; break;
            }
            
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${dateStr}${random}`;
        }

        // æœå°‹é …ç›®
        function searchItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;

            let filteredData = allData.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.code.toLowerCase().includes(searchTerm) ||
                    item.recipient.toLowerCase().includes(searchTerm) ||
                    item.room.toLowerCase().includes(searchTerm) ||
                    item.description.toLowerCase().includes(searchTerm);
                
                const matchesType = !typeFilter || item.type === typeFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;

                return matchesSearch && matchesType && matchesStatus;
            });

            displayItems(filteredData);
        }

        // é¡¯ç¤ºQRç¢¼
        function showQR(code) {
            document.getElementById('qrCodeText').textContent = code;
            
            // æ¸…ç©ºèˆŠçš„QRç¢¼
            const container = document.getElementById('qrCodeContainer');
            container.innerHTML = '';
            
            // ä½¿ç”¨qrcode-generatorç”ŸæˆQRç¢¼
            try {
                const qr = qrcode(0, 'M');
                qr.addData(code);
                qr.make();
                
                // å‰µå»ºQRç¢¼åœ–ç‰‡
                const qrDiv = document.createElement('div');
                qrDiv.innerHTML = qr.createImgTag(4, 8);
                qrDiv.style.textAlign = 'center';
                container.appendChild(qrDiv);
                
            } catch (error) {
                // å¦‚æœQRç¢¼åº«å¤±æ•—ï¼Œé¡¯ç¤ºæ–‡å­—ç‰ˆæœ¬
                container.innerHTML = `
                    <div style="border: 2px solid #333; padding: 20px; font-family: monospace; font-size: 18px; text-align: center;">
                        ${code}
                    </div>
                `;
            }
            
            document.getElementById('qrModal').style.display = 'flex';
        }

        // é—œé–‰QRç¢¼å½ˆçª—
        function closeQR() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // ä¸‹è¼‰QRç¢¼
        function downloadQR() {
            const code = document.getElementById('qrCodeText').textContent;
            const img = document.querySelector('#qrCodeContainer img');
            
            if (img) {
                // å¦‚æœæœ‰QRç¢¼åœ–ç‰‡ï¼Œå‰µå»ºä¸‹è¼‰é€£çµ
                const link = document.createElement('a');
                link.download = `QR_${code}.png`;
                link.href = img.src;
                link.click();
            } else {
                // å¦‚æœæ²’æœ‰åœ–ç‰‡ï¼Œæç¤ºç”¨æˆ¶æˆªåœ–
                alert(`è«‹æˆªåœ–ä¿å­˜QRç¢¼\nä»£è™Ÿï¼š${code}`);
            }
        }

        // é–‹å§‹æƒæï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
        function startScanner() {
            if (isScanning) return;
            
            const scanner = document.getElementById('scanner');
            scanner.innerHTML = '<div style="padding: 20px; text-align: center;">æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...</div>';
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 300 },
                        height: { ideal: 200 }
                    } 
                })
                .then(function(stream) {
                    isScanning = true;
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'cover';
                    
                    scanner.innerHTML = '';
                    scanner.appendChild(video);
                    
                    // é¡¯ç¤ºä½¿ç”¨æç¤º
                    const tip = document.createElement('div');
                    tip.innerHTML = '<p style="margin-top: 10px; font-size: 12px; color: #666;">ğŸ“± è«‹å°‡QRç¢¼å°æº–ç›¸æ©Ÿï¼Œç„¶å¾Œåœ¨ä¸‹æ–¹æ‰‹å‹•è¼¸å…¥ä»£è™Ÿ</p>';
                    scanner.appendChild(tip);
                    
                })
                .catch(function(error) {
                    console.error('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ:', error);
                    scanner.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ä½¿ç”¨æ‰‹å‹•è¼¸å…¥</div>';
                });
            } else {
                scanner.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½ï¼Œè«‹ä½¿ç”¨æ‰‹å‹•è¼¸å…¥</div>';
            }
        }

        // åœæ­¢æƒæ
        function stopScanner() {
            isScanning = false;
            const scanner = document.getElementById('scanner');
            const video = scanner.querySelector('video');
            
            if (video && video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
            }
            
            scanner.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">ç›¸æ©Ÿå·²åœæ­¢</div>';
        }

        // æ ¹æ“šä»£è™Ÿæœå°‹
        function searchByCode() {
            const code = document.getElementById('manualCode').value.trim();
            if (!code) {
                showMessage('è«‹è¼¸å…¥ä»£è™Ÿ', 'error');
                return;
            }
            
            const item = allData.find(item => item.code === code);
            const resultDiv = document.getElementById('scanResult');
            
            if (item) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>âœ… æ‰¾åˆ°é …ç›®</h4>
                        <div style="margin: 15px 0;">
                            <p><strong>ä»£è™Ÿï¼š</strong>${item.code}</p>
                            <p><strong>é¡å‹ï¼š</strong>${getTypeIcon(item.type)} ${item.type}</p>
                            <p><strong>æ”¶ä»¶äººï¼š</strong>${item.recipient}</p>
                            <p><strong>æˆ¿è™Ÿï¼š</strong>${item.room}</p>
                            <p><strong>å¯„ä»¶äººï¼š</strong>${item.sender}</p>
                            <p><strong>æè¿°ï¼š</strong>${item.description}</p>
                            ${item.amount ? `<p><strong>é‡‘é¡ï¼š</strong>$${item.amount}</p>` : ''}
                            <p><strong>ç‹€æ…‹ï¼š</strong><span class="status status-${getStatusClass(item.status)}">${item.status}</span></p>
                            <p><strong>è™•ç†å“¡å·¥ï¼š</strong>${item.staff}</p>
                            <p><strong>å»ºç«‹æ™‚é–“ï¼š</strong>${formatDateTime(item.datetime)}</p>
                            ${item.remarks ? `<p><strong>å‚™è¨»ï¼š</strong>${item.remarks}</p>` : ''}
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="window.updateStatus('${item.code}', 'å·²å–ä»¶')">âœ… æ¨™è¨˜å·²å–ä»¶</button>
                            <button class="btn btn-warning" onclick="window.updateStatus('${item.code}', 'å·²é€šçŸ¥')">ğŸ“ æ¨™è¨˜å·²é€šçŸ¥</button>
                            <button class="btn btn-primary" onclick="window.showQR('${item.code}')">ğŸ“± é¡¯ç¤ºQRç¢¼</button>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ æœªæ‰¾åˆ°é …ç›®</h4>
                        <p>ä»£è™Ÿ "${code}" ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ˜¯å¦æ­£ç¢º</p>
                    </div>
                `;
            }
            
            document.getElementById('manualCode').value = '';
        }

        // æ›´æ–°ç‹€æ…‹
        async function updateStatus(code, newStatus) {
            if (!newStatus) return;
            
            try {
                // é€™è£¡éœ€è¦å‘¼å« Google Sheets API ä¾†æ›´æ–°è³‡æ–™
                // ç”±æ–¼æ˜¯ç¤ºç¯„ç‰ˆæœ¬ï¼Œæˆ‘å€‘å…ˆåœ¨å‰ç«¯æ¨¡æ“¬æ›´æ–°
                const item = allData.find(item => item.code === code);
                if (item) {
                    item.status = newStatus;
                    if (newStatus === 'å·²å®Œæˆ' || newStatus === 'å·²å–ä»¶') {
                        item.completedTime = new Date().toISOString().replace('T', ' ').substr(0, 19);
                    }
                }
                
                showMessage(`ç‹€æ…‹å·²æ›´æ–°ï¼š${code} â†’ ${newStatus}`, 'success');
                
                // é‡æ–°æ•´ç†é¡¯ç¤º
                searchItems();
                updateDashboard();
                
                // æ¸…ç©ºæƒæçµæœä¸­çš„ç‹€æ…‹æ›´æ–°
                const scanResult = document.getElementById('scanResult');
                if (scanResult.innerHTML.includes(code)) {
                    searchByCode();
                }
                
            } catch (error) {
                console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
                showMessage('æ›´æ–°ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // åˆ‡æ›æ¨™ç±¤é 
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤æŒ‰éˆ•çš„ active ç‹€æ…‹
            const buttons = document.querySelectorAll('.nav-tab');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•ä¸¦è¨­ç‚º active
            const activeButton = Array.from(buttons).find(btn => btn.onclick.toString().includes(tabName));
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // åœæ­¢æƒæå¦‚æœé›¢é–‹æƒæé é¢
            if (tabName !== 'scan') {
                stopScanner();
            }
        }

        // æ›´æ–°è¡¨å–®æ¬„ä½
        function updateFormFields() {
            const type = document.getElementById('itemType').value;
            const senderLabel = document.getElementById('senderLabel');
            const descriptionLabel = document.getElementById('descriptionLabel');
            const amountGroup = document.getElementById('amountGroup');
            
            switch(type) {
                case 'å¿«éåŒ…è£¹':
                    senderLabel.textContent = 'å¿«éå…¬å¸';
                    descriptionLabel.textContent = 'è¿½è¹¤è™Ÿç¢¼';
                    amountGroup.style.display = 'none';
                    document.getElementById('sender').placeholder = 'è«‹è¼¸å…¥å¿«éå…¬å¸';
                    document.getElementById('description').placeholder = 'è«‹è¼¸å…¥è¿½è¹¤è™Ÿç¢¼';
                    break;
                case 'å¯„å­˜è½‰äº¤':
                    senderLabel.textContent = 'å¯„ä»¶äºº';
                    descriptionLabel.textContent = 'ç‰©å“æè¿°';
                    amountGroup.style.display = 'none';
                    document.getElementById('sender').placeholder = 'è«‹è¼¸å…¥å¯„ä»¶äºº';
                    document.getElementById('description').placeholder = 'è«‹è¼¸å…¥ç‰©å“æè¿°';
                    break;
                case 'ä»£ä»˜æ¬¾é …':
                    senderLabel.textContent = 'ä»˜æ¬¾å°è±¡';
                    descriptionLabel.textContent = 'ä»˜æ¬¾é …ç›®';
                    amountGroup.style.display = 'block';
                    document.getElementById('sender').placeholder = 'è«‹è¼¸å…¥ä»˜æ¬¾å°è±¡';
                    document.getElementById('description').placeholder = 'è«‹è¼¸å…¥ä»˜æ¬¾é …ç›®';
                    break;
            }
        }

        // å·¥å…·å‡½æ•¸
        function getTypeIcon(type) {
            switch(type) {
                case 'å¿«éåŒ…è£¹': return 'ğŸ“¦';
                case 'å¯„å­˜è½‰äº¤': return 'ğŸ“‹';
                case 'ä»£ä»˜æ¬¾é …': return 'ğŸ’°';
                default: return 'ğŸ“„';
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'å¾…è™•ç†': return 'pending';
                case 'å·²é€šçŸ¥': return 'notified';
                case 'å·²å–ä»¶':
                case 'å·²å®Œæˆ': return 'completed';
                default: return 'pending';
            }
        }

        function formatDateTime(datetime) {
            if (!datetime) return '-';
            const date = new Date(datetime);
            return date.toLocaleString('zh-TW', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showMessage(message, type) {
            const resultDivs = ['addResult', 'scanResult'];
            resultDivs.forEach(divId => {
                const div = document.getElementById(divId);
                if (div) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = type;
                    messageDiv.textContent = message;
                    div.innerHTML = '';
                    div.appendChild(messageDiv);
                    
                    // 3ç§’å¾Œè‡ªå‹•æ¸…é™¤è¨Šæ¯
                    setTimeout(() => {
                        if (div.contains(messageDiv)) {
                            div.removeChild(messageDiv);
                        }
                    }, 3000);
                }
            });
        }

        // é»æ“Šå½ˆçª—å¤–éƒ¨é—œé–‰
        document.getElementById('qrModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeQR();
            }
        });

        // åˆå§‹åŒ–è¡¨å–®æ¬„ä½
        updateFormFields();
